---
title: '냉부해 추천 레시피 개발기'
date: 2023-06-05 04:59:57
category: 'back-end'
profile : 'https://refrigerator-image.s3.ap-northeast-2.amazonaws.com/icon/IMG_9705.JPG'
author: '김나현'
draft: false
---

안녕하세요. 저는 냉장고를 부탁해 프로젝트에서 서버 개발자를 맡고 있는 김나현 입니다. 🙂

이번 글에서는 냉장고를 부탁해의 핵심 서비스인 레시피 추천 서비스를 개발하며 겪었던 경험을 얘기해보려 합니다. 

### 🍴 우리는 이렇게 레시피를 추천해드립니다 
<img width="300" alt="스크린샷 2023-06-05 오후 5 08 28" src="https://github.com/xiu0327/2023-refrigerator-recipe/assets/78461009/3038ef9f-94e1-49a2-89b5-e186608eb236">

냉부해의 추천 레시피 로직은 다음과 같이 진행됩니다.

**1. 사용자의 식재료와 음식을 만들기 위해 필요한 식재료(레시피 식재료)를 비교하여 일치율을 계산합니다.**

**2. 일치율이 높은순대로 정렬하여 상위 10개의 레시피를 사용자에게 제공합니다.**

냉장고를 부탁해 프로젝트 기획을 할 당시, 팀원들과 추천 알고리즘에 대해 많은 고민을 했습니다. <br>그중 대표적인 추천 알고리즘으로 컨텐츠 기반 추천 알고리즘과 협업 필터링 알고리즘이 있었는데요. 

아쉽게도 해당 알고리즘들은 저희 서비스에 적용하기 적절하지 않았습니다. <br>

회원 데이터가 쌓이고 회원이 저희 서비스를 이용하며 데이터를 남겨준다면 충분히 적용 가능한 얘기지만, <br>
저희는 초기 서비스 구현 단계였으며, <br> 그렇다고 추천 로직을 회원 데이터가 쌓인 뒤 구현하기엔 "추천 레시피"는 냉부해의 핵심 서비스였기 때문에 고객에게 즉각적인 결과를 보여줘야 했습니다. 

그래서 여러 회의 끝에 도출한 알고리즘이 **일치율 계산**이었습니다. 

### 🙋‍♀️ 일치율은 어떻게 계산하나요?
사용자는 저희 서비스를 이용하기 위해 자신이 소유한 식재료를 등록합니다. 

만약 위와 같이 사용자가 "사과, 계란, 빵, 우유, 감자"를 등록했다면, 샌드위치 > 감자 샐러드 순으로 레시피가 추천됩니다.

반면, 김치찌개는 김치찌개를 만들기 위해 필요한 식재료를 사용자가 하나도 가지지 않았으므로 추천 레시피에 노출되지 않습니다.

<img width="1394" alt="스크린샷 2023-06-05 오후 5 29 15" src="https://github.com/xiu0327/2023-refrigerator-recipe/assets/78461009/7b0e91a7-581e-4ec0-a000-a1eb21d079bd">


처음엔 일치율을 단순히 식재료 이름을 비교하여 계산하였습니다.

> 일치율 = ((사용자 식재료 == 레시피 식재료) 개수 / 레시피 식재료 개수) * 100

하지만 이렇게 계산했을 때, 일치율의 의미가 모호해지는 순간이 생겼습니다.

만약 사용자가 레시피의 주재료보다 부재료 혹은 양념이 되는 식재료를 더 많이 갖고 있는 경우, <br> 
일치율이 아무리 높다고 하더라도 사용자가 만들 수 없는 식재료일 가능성이 높습니다.

그래서 일치율을 계산할 때 **가중치**를 적용하였습니다.

<img width="364" alt="스크린샷 2023-06-05 오후 10 48 59" src="https://github.com/xiu0327/2023-refrigerator-recipe/assets/78461009/a2cf3d71-7631-4bcd-9a32-d4e51babd00f">

저희 레시피 식재료는 주재료/부재료/양념으로 유형이 나뉘어져 있습니다. <br> 그래서 음식을 조리할 때 꼭 필요한 재료 순으로 가중치를 부여하여 계산하였습니다.

<img width="1394" alt="스크린샷 2023-06-05 오후 10 52 18" src="https://github.com/xiu0327/2023-refrigerator-recipe/assets/78461009/f87cc72c-e2ed-4e71-abc3-d64e666b4d6d">

예를 들어, 위와 같이 사용자 A와 사용자 B가 식재료를 소유하고 있는 상황이라 가정해봅시다.

가중치를 부여하지 않고 일치율을 계산하면 A와 B 모두 샌드위치에 대해 62.5%로 동일한 일치율로 계산되겠지만, <br>
가중치를 부여한다면 B가 더 주재료를 많이 가지고 있으므로 A 보다 B 사용자에게 샌드위치가 추천될 가능성이 더 높아집니다. 

### 🧐 그럼 구현은 어떻게 했나요?

<img width="1630" alt="스크린샷 2023-06-05 오후 11 17 04" src="https://github.com/xiu0327/2023-refrigerator-recipe/assets/78461009/759529d2-451e-4d81-9c90-32faa1abc747">

저희 냉부해는 헥사고날 아키텍처를 사용하고 있기 때문에 위와 같이 설계를 하고 코드를 구현했습니다.

- `RecipeRecommendController` : 클라이언트로부터 memberId(이메일)을 받습니다.
- `RecipeRecommendService`: RecommendRecipeUseCase의 구현체입니다. DB에서 레시피 식재료 정보와 사용자 식재료 정보를 가져옵니다.
- `RecipeIngredientTuple` : 레시피 식재료 이름과 타입이 저장된 커스텀 자료구조 입니다.
- `RecommendMatchPercent` : RecipeIngredientTuple 형태의 리스트를 가진 일급 컬렉션입니다. 일치율을 계산하는 함수와 일치율을 조회하는 함수가 있습니다.
- `RecipeRecommendDomainService` : 일치율이 높은 순대로 레시피를 정렬하고 상위 10개를 추출하는 함수가 있습니다.

<br>
여기서 도메인 서비스와 UseCase 구현체를 구분해놓은 이유는 일치율 계산, 일치율 정렬과 같은 핵심 로직은 DB에서 데이터를 가져오는 코드와 섞이지 않게 하기 위함이었습니다. 

<br>
<br>

처음엔 UseCase 구현체에 일치율 계산, 일치율 정렬 로직을 구현했으나, <br> 구현을 하다보니 저도 모르게 비즈니스 로직이 RecipeRecommendAdapter까지 번져나갔습니다. <br>

그래서 핵심 로직은 도메인 영역에 응집되어 있어야 추후 유지보수가 편할 것 같아 리팩터링을 진행하였고 지금과 같은 구조가 되었습니다. 🙂

<img width="1059" alt="스크린샷 2023-06-05 오후 11 27 58" src="https://github.com/xiu0327/2023-refrigerator-recipe/assets/78461009/7a072f94-741a-45f6-b66d-c7633cfd684c">

`RecommendMatchPercent` 클래스 안에는 `calculateMatchPercent`라는 일치율 계산 함수가 있습니다. 

각 레시피에 해당하는 식재료가 Set 자료 구조로 되어있고, 이를 key = 식재료 이름, value = 식재료 가중치로 이루어진 Map으로 변경합니다.

다음으로 레시피 식재료의 가중치 총합을 구하고, 레시피 식재료 중 사용자가 가진 식재료의 가중치 총합을 구해서 나누어줍니다. <br>
대부분 소숫점이 계산되기 때문에 보다 정밀한 값을 위해 BigDecimal을 사용하여 계산했습니다.

<img width="974" alt="스크린샷 2023-06-05 오후 11 35 02" src="https://github.com/xiu0327/2023-refrigerator-recipe/assets/78461009/b0f52c3a-2625-45d4-820e-f9e54404352c">

정렬은 `RecommendDomainService에서` 이루어집니다.<br>
먼저 일치율을 계산하여 내림차순으로 정렬한 다음 10개를 추출합니다.

### 😙 마치며

레시피 추천 기능을 구현하며 "좀 더 나은 알고리즘이 없을까?" 고민하며 많이 배우고 성장한 것 같습니다. <br>
물론 저희 냉부해의 추천 로직은 '추천 시스템'이라는 거창한 단어에 속하긴 보단 단순 데이터 필터링에 불과하며 부족한 점이 많다고 생각합니다.<br> 하지만 계속해서 기능에 대해 고민하고 보다 더 나은 방법을 찾지 않을까요? 😀

지금까지 냉부해의 레시피 추천 기능 구현 이야기였습니다. 읽어주셔서 감사합니다.